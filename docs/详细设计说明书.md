# Detailed Design Document / 详细设计说明书

**Project Name / 项目名称:** Conversation Kit Demo  
**Version / 版本:** 1.0  
**Date / 日期:** 2026-02-28  

---

## 1. Introduction / 引言

### 1.1 Purpose / 目的

This document provides detailed design specifications for implementing the Conversation Kit Demo.
/ 本文档提供实现 Conversation Kit Demo 的详细设计规范。

It serves as a guide for developers during the implementation phase.
/ 它在实现阶段作为开发人员的指南。

### 1.2 References / 引用

- [SRS: docs/需求规约说明书.md](./需求规约说明书.md)
- [HLD: docs/概要设计说明书.md](./概要设计说明书.md)
- [Test Report: docs/测试报告.md](./测试报告.md)
- [Roadmap: docs/路线图.md](./路线图.md)

---

## 2. Component Design / 组件设计

### 2.1 SDD-001: ConversationKit Component / 对话套件组件

**Location / 位置:** `src/components/ConversationKit/index.vue`

**Purpose / 目的:** Main container component coordinating all sub-components
/ 主容器组件，协调所有子组件

**State / 状态:**
```typescript
const messages = ref<Message[]>([])           // All messages / 所有消息
const inputText = ref('')                     // Current input / 当前输入
const isStreaming = ref(false)                // Stream status / 流状态
const activeAnchor = ref('')                  // Active anchor / 激活锚点
const sideWidth = ref(280)                    // Sidebar width / 侧边栏宽度
const sidePosition = ref<SidePosition>('right')  // Sidebar position / 侧边栏位置
```

**Computed / 计算属性:**
```typescript
const treeData = computed((): TreeNode[] => {
  // Transform messages to tree structure
  // 将消息转换为树结构
})
```

**Methods / 方法:**
| Method / 方法 | Description / 描述 |
|--------------|-------------------|
| `handleSend()` | Process user input and start stream / 处理用户输入并启动流 |
| `startStream(query)` | Simulate AI streaming response / 模拟 AI 流式响应 |
| `handleNodeClick(node)` | Navigate to tree node location / 导航到树节点位置 |
| `handleSearchResultClick(result)` | Navigate to search result / 导航到搜索结果 |

**Implementation Notes / 实现说明:**
- Uses `setInterval` for character-by-character streaming
- 使用 `setInterval` 进行逐字符流式输出
- Replaces entire message object to trigger reactivity
- 替换整个消息对象以触发响应式更新

---

### 2.2 SDD-002: MessageStream Component / 消息流组件

**Location / 位置:** `src/components/ConversationKit/MessageStream/index.vue`

**Purpose / 目的:** Render message list with anchor support
/ 渲染带锚点支持的消息列表

**Props / 属性:**
```typescript
interface Props {
  messages: Message[]       // Message list / 消息列表
  activeAnchor?: string     // Currently active anchor / 当前激活锚点
}
```

**Events / 事件:**
```typescript
interface Emits {
  (e: 'anchorVisible', anchorId: string): void  // Anchor in viewport / 锚点进入视口
  (e: 'scrollToAnchor', anchorId: string): void // Scroll request / 滚动请求
}
```

**Exposed Methods / 暴露方法:**
```typescript
defineExpose({
  scrollToAnchor: (anchorId: string) => void  // Scroll to anchor / 滚动到锚点
})
```

**Implementation / 实现:**
- Uses `useAnchorInject` composable for anchor detection
- 使用 `useAnchorInject` 组合式函数进行锚点检测
- Registers anchor elements via `data-anchor-id` attributes
- 通过 `data-anchor-id` 属性注册锚点元素

---

### 2.3 SDD-003: MarkdownRenderer Component / Markdown 渲染组件

**Location / 位置:** `src/components/ConversationKit/MessageStream/MarkdownRenderer.vue`

**Purpose / 目的:** Parse Markdown and render with anchor IDs
/ 解析 Markdown 并使用锚点 ID 渲染

**Props / 属性:**
```typescript
interface Props {
  content: string      // Markdown content / Markdown 内容
  messageId?: string   // Parent message ID / 父消息标识
}
```

**Algorithm / 算法:**
```
1. Escape HTML special characters
   转义 HTML 特殊字符
2. Extract headings with character indices
   提取带字符索引的标题
3. Replace headers with anchor IDs: {messageId}-heading-{index}
   用锚点 ID 替换标题：{messageId}-heading-{索引}
4. Process inline formatting (bold, italic, code)
   处理行内格式（粗体、斜体、代码）
5. Process block elements (lists, code blocks)
   处理块级元素（列表、代码块）
```

**Supported Syntax / 支持语法:**
| Syntax / 语法 | Output / 输出 |
|--------------|--------------|
| `# Title` | H1 with anchor / 带锚点的 H1 |
| `## Title` | H2 with anchor / 带锚点的 H2 |
| `### Title` | H3 / H3 |
| `**bold**` | Bold text / 粗体文本 |
| `*italic*` | Italic text / 斜体文本 |
| `` `code` `` | Inline code / 行内代码 |
| `- item` | List item / 列表项 |

---

### 2.4 SDD-004: SidePanel Component / 侧边栏组件

**Location / 位置:** `src/components/ConversationKit/SidePanel/index.vue`

**Purpose / 目的:** Container for sidebar with tabs and resize
/ 带标签页和调整大小功能的侧边栏容器

**Props / 属性:**
```typescript
interface Props {
  modelValue?: number        // Width in px / 宽度（像素）
  position?: SidePosition    // 'left' | 'right' / 位置
  treeData?: TreeNode[]      // Navigation tree / 导航树
  activeAnchor?: string      // Active anchor / 激活锚点
}
```

**Composables Used / 使用的组合式函数:**
- `useActiveTab()` - Tab state management / 标签状态管理
- `useDragResize()` - Resize functionality / 调整大小功能

---

### 2.5 SDD-005: TreeTab Component / 树形标签页组件

**Location / 位置:** `src/components/ConversationKit/SidePanel/TreeTab.vue`

**Purpose / 目的:** Display hierarchical conversation structure
/ 显示层级对话结构

**Features / 功能:**
- Expand/collapse parent nodes / 展开/折叠父节点
- Select nodes for navigation / 选择节点进行导航
- Sync with active anchor / 与激活锚点同步

**State Management / 状态管理:**
```typescript
const { expandedKeys, selectedKey, toggleNode, selectNode } = useTreeState(
  treeDataRef,
  onNodeClick
)
```

---

### 2.6 SDD-006: SearchTab Component / 搜索标签页组件

**Location / 位置:** `src/components/ConversationKit/SidePanel/SearchTab.vue`

**Purpose / 目的:** Search interface with results display
/ 带结果显示的搜索界面

**State / 状态:**
```typescript
const store = useConversationStore()  // Pinia store / Pinia 存储
const searchQuery = ref('')           // Search input / 搜索输入
const hasSearched = ref(false)        // Search performed flag / 搜索执行标志
const selectedResultId = ref('')      // Selected result / 选中的结果
```

**Computed / 计算属性:**
```typescript
const results = computed(() => store.searchResults)  // Search results / 搜索结果
```

**Known Issues / 已知问题:**
- Search returns no results despite matches in content
- 尽管内容中有匹配项，搜索仍返回无结果
- See [Test Report TC-007](./测试报告.md#tc-007)
- 参见测试报告 TC-007

---

## 3. Data Structures / 数据结构

### 3.1 Type Definitions / 类型定义

**Location / 位置:** `src/components/ConversationKit/types.ts`

```typescript
// Markdown heading / Markdown 标题
export interface Heading {
  level: 1 | 2 | 3;      // Heading level / 标题级别
  title: string;         // Heading text / 标题文本
  index: number;         // Position in content / 在内容中的位置
}

// Chat message / 聊天消息
export interface Message {
  id: string;            // Unique ID / 唯一标识
  role: 'user' | 'assistant';  // Sender / 发送者
  content: string;       // Content / 内容
  summary?: string;      // Summary / 摘要
  headings?: Heading[];  // Headings / 标题列表
  timestamp: number;     // Timestamp / 时间戳
}

// Tree node / 树节点
export interface TreeNode {
  id: string;            // Node ID / 节点标识
  type: 'turn' | 'chunk'; // Type / 类型
  summary: string;       // Display text / 显示文本
  level: number;         // Nesting level / 嵌套级别
  anchorId: string;      // Anchor / 锚点
  collapsed: boolean;    // Collapsed state / 折叠状态
  children: TreeNode[];  // Children / 子节点
  meta: { createdAt: number; wordCount?: number };
}

// Search result / 搜索结果
export interface SearchResult {
  id: string;            // Result ID / 结果标识
  anchorId: string;      // Message anchor / 消息锚点
  turnIndex: number;     // Turn number / 轮次编号
  chunkIndex?: number;   // Heading index / 标题索引
  preview: string;       // Text preview / 文本预览
  positions: number[];   // Match positions / 匹配位置
}
```

---

## 4. State Management / 状态管理

### 4.1 Pinia Store: conversationStore / 对话存储

**Location / 位置:** `src/components/ConversationKit/stores/conversationStore.ts`

**State / 状态:**
```typescript
const messages = ref<Message[]>([])
const isStreaming = ref(false)
const activeAnchor = ref<string>('')
const searchQuery = ref('')
const searchResults = ref<SearchResult[]>([])
```

**Getters / 获取器:**
```typescript
const messageCount = computed(() => messages.value.length)
const hasMessages = computed(() => messages.value.length > 0)
const treeData = computed(() => /* transform messages to tree */)
```

**Actions / 动作:**
```typescript
function addMessage(message: Omit<Message, 'id' | 'timestamp'>): Message
function updateMessage(id: string, updates: Partial<Message>): void
function setActiveAnchor(anchorId: string): void
function search(query: string): void
function clearMessages(): void
```

---

## 5. Composables Design / 组合式函数设计

### 5.1 useStreamRender / 流式渲染

**Location / 位置:** `src/components/ConversationKit/MessageStream/composables/useStreamRender.ts`

**Purpose / 目的:** Simulate streaming message output
/ 模拟流式消息输出

**Returns / 返回:**
```typescript
{
  isStreaming: Ref<boolean>,           // Streaming status / 流式状态
  extractHeadings: (content: string) => Heading[],  // Extract headings / 提取标题
  generateSummary: (content: string) => string      // Generate summary / 生成摘要
}
```

### 5.2 useAnchorInject / 锚点注入

**Location / 位置:** `src/components/ConversationKit/MessageStream/composables/useAnchorInject.ts`

**Purpose / 目的:** Detect visible anchors and handle scrolling
/ 检测可见锚点并处理滚动

**Uses / 使用:** IntersectionObserver API
/ IntersectionObserver API

### 5.3 useDragResize / 拖拽调整大小

**Location / 位置:** `src/components/ConversationKit/SidePanel/composables/useDragResize.ts`

**Purpose / 目的:** Handle sidebar resize via mouse drag
/ 通过鼠标拖拽处理侧边栏调整大小

**Events / 事件:** mousedown, mousemove, mouseup
/ mousedown、mousemove、mouseup

### 5.4 useTreeState / 树状态

**Location / 位置:** `src/components/ConversationKit/SidePanel/composables/useTreeState.ts`

**Purpose / 目的:** Manage tree expand/collapse and selection state
/ 管理树展开/折叠和选择状态

---

## 6. Algorithm Details / 算法细节

### 6.1 Heading Extraction Algorithm / 标题提取算法

```typescript
function extractHeadings(content: string): Heading[] {
  const headings: Heading[] = []
  const lines = content.split('\n')
  let charIndex = 0
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i]
    if (!line) {
      charIndex += 1
      continue
    }
    const match = line.match(/^(#{1,3})\s+(.+)$/)
    if (match && match[1] && match[2]) {
      headings.push({
        level: match[1].length,
        title: match[2].trim(),
        index: charIndex
      })
    }
    charIndex += line.length + 1
  }
  
  return headings
}
```

**Complexity / 复杂度:** O(n) where n = number of lines
/ O(n)，n 为行数

### 6.2 Search Algorithm / 搜索算法

```typescript
function search(query: string): void {
  const lowerQuery = query.toLowerCase()
  const results: SearchResult[] = []
  
  messages.value.forEach((msg, turnIndex) => {
    const content = msg.content.toLowerCase()
    const positions: number[] = []
    let pos = content.indexOf(lowerQuery)
    
    while (pos !== -1) {
      positions.push(pos)
      pos = content.indexOf(lowerQuery, pos + 1)
    }
    
    if (positions.length > 0) {
      results.push({
        id: `search-${msg.id}`,
        anchorId: msg.id,
        turnIndex,
        preview: extractPreview(msg.content, positions[0], query.length),
        positions
      })
    }
  })
  
  searchResults.value = results
}
```

**Complexity / 复杂度:** O(m × n) where m = messages, n = content length
/ O(m × n)，m 为消息数，n 为内容长度

---

## 7. Cross-References / 交叉引用

| Design Element / 设计元素 | SRS Reference / SRS 引用 | HLD Reference / HLD 引用 |
|--------------------------|-------------------------|-------------------------|
| FR-001 Message Display | [SRS 3.1](./需求规约说明书.md#31-fr-001-message-display--消息显示) | [HLD 2.2](./概要设计说明书.md#22-system-decomposition--系统分解) |
| FR-002 Streaming | [SRS 3.2](./需求规约说明书.md#32-fr-002-streaming-output--流式输出) | [HLD 5.1](./概要设计说明书.md#51-composable-pattern--组合式模式) |
| FR-006 Anchor Navigation | [SRS 3.6](./需求规约说明书.md#36-fr-006-anchor-navigation--锚点导航) | [HLD 8.2](./概要设计说明书.md#82-decision-markdown-parsing-strategy--决策markdown解析策略) |
| Tree View | [SRS 3.5](./需求规约说明书.md#35-fr-005-tree-view-navigation--树形视图导航) | [HLD 2.3](./概要设计说明书.md#23-component-responsibilities--组件职责) |

---

## 8. Known Issues / 已知问题

| Issue / 问题 | Component / 组件 | Severity / 严重程度 | Reference / 引用 |
|-------------|-----------------|-------------------|-----------------|
| Search returns no results / 搜索返回无结果 | SearchTab | High / 高 | [Test TC-007](./测试报告.md#tc-007) |
| Subheading navigation doesn't scroll / 子标题导航不滚动 | TreeTab | Medium / 中 | [Test TC-006](./测试报告.md#tc-006) |

---

## 9. Change History / 变更历史

| Date / 日期 | Version / 版本 | Changes / 变更 | Author / 作者 |
|-------------|----------------|----------------|---------------|
| 2026-02-28 | 1.0 | Initial SDD / 初始详细设计 | Development Team / 开发团队 |
